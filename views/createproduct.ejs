<%- include('head.ejs') %>

<!-- Content Header -->
<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>Product Form</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item active">Product Form</li>
        </ol>
      </div>
    </div>
  </div>
</section>

<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8 offset-md-2">

        <!-- Flash messages -->
        <% if (error_msg && error_msg.length > 0) { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert" id="flash-msg">
            <%= error_msg %>
            <button type="button" class="close text-white" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        <% } %>
        <% if (success_msg && success_msg.length > 0) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert" id="flash-msg">
            <%= success_msg %>
            <button type="button" class="close text-white" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        <% } %>

        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">Create Product</h3>
          </div>
          <form action="/createproduct" method="post">
            <div class="card-body">

              <!-- Product Name -->
              <div class="form-group">
                <label for="product_name">Product Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="product_name"
                  name="name"
                  placeholder="Enter product name"
                  value="<%= formData?.name || '' %>"
                />
              </div>

              <!-- Category -->
              <div class="form-group">
                <label for="category">Category</label>
                <select name="category_id" id="category" class="form-control">
                  <option value="">-- Select Category --</option>
                  <% categories.forEach(cat => { %>
                    <option value="<%= cat.category_id %>" <%= formData?.category_id == cat.category_id ? 'selected' : '' %>>
                      <%= cat.name %>
                    </option>
                  <% }) %>
                </select>
              </div>

              <!-- Product Sizes -->
              <div class="form-group">
                <label>Product Sizes</label>
                <div id="sizes-container">
                  <% if (formData && formData.size_id && formData.size_id.length > 0) { %>
                    <% for (let i = 0; i < formData.size_id.length; i++) { %>
                      <div class="size-item row mb-2">

                        <!-- Size Dropdown -->
                        <div class="col-md-3">
                          <select name="size_id[]" class="form-control">
                            <option value="">-- Size --</option>
                            <% sizes.forEach(s => { %>
                              <option value="<%= s.size_id %>" <%= formData.size_id[i] == s.size_id ? 'selected' : '' %>><%= s.size_label %></option>
                            <% }) %>
                          </select>
                        </div>

                        <!-- Unit Dropdown -->
                        <div class="col-md-2">
                          <select name="unit_id[]" class="form-control">
                            <option value="">-- Unit --</option>
                            <% units.forEach(u => { %>
                              <option value="<%= u.unit_id %>" <%= formData.unit_id[i] == u.unit_id ? 'selected' : '' %>><%= u.unit_label %></option>
                            <% }) %>
                          </select>
                        </div>

                        <div class="col-md-2">
                          <input type="number" step="0.01" name="cost_price[]" class="form-control" placeholder="Cost Price" value="<%= formData.cost_price[i] || '' %>" />
                        </div>
                        <div class="col-md-2">
                          <input type="number" step="0.01" name="sale_price[]" class="form-control" placeholder="Sale Price" value="<%= formData.sale_price[i] || '' %>" />
                        </div>
                        <div class="col-md-2">
                          <input type="text" name="barcode[]" class="form-control" placeholder="Barcode (optional)" value="<%= formData.barcode[i] || '' %>" />
                        </div>
                        <div class="col-md-1">
                          <button type="button" class="btn btn-danger btn-sm remove-size">X</button>
                        </div>
                      </div>
                    <% } %>
                  <% } else { %>
                    <!-- Default one row -->
                    <div class="size-item row mb-2">
                      <div class="col-md-3">
                        <select name="size_id[]" class="form-control">
                          <option value="">-- Size --</option>
                          <% sizes.forEach(s => { %>
                            <option value="<%= s.size_id %>"><%= s.size_label %></option>
                          <% }) %>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <select name="unit_id[]" class="form-control">
                          <option value="">-- Unit --</option>
                          <% units.forEach(u => { %>
                            <option value="<%= u.unit_id %>"><%= u.unit_label %></option>
                          <% }) %>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <input type="number" step="0.01" name="cost_price[]" class="form-control" placeholder="Cost Price" />
                      </div>
                      <div class="col-md-2">
                        <input type="number" step="0.01" name="sale_price[]" class="form-control" placeholder="Sale Price" />
                      </div>
                      <div class="col-md-2">
                        <input type="text" name="barcode[]" class="form-control" placeholder="Barcode (optional)" />
                      </div>
                      <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm remove-size">X</button>
                      </div>
                    </div>
                  <% } %>
                </div>
                <button type="button" id="add-size" class="btn btn-sm btn-secondary mt-2">Add More Size</button>
              </div>

            </div>
            <div class="card-footer">
              <button type="submit" class="btn btn-primary">Create Product</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>
</section>

<%- include('foot.ejs') %>

<script>
  // Auto-hide flash messages
  setTimeout(() => {
    const msg = document.getElementById("flash-msg");
    if (msg) {
      msg.style.transition = "opacity 0.5s ease";
      msg.style.opacity = "0";
      setTimeout(() => msg.remove(), 2000);
    }
  }, 3000);

  // Add more sizes dynamically
  const sizesContainer = document.getElementById("sizes-container");

  document.getElementById("add-size").addEventListener("click", function () {
    const newItem = sizesContainer.firstElementChild.cloneNode(true);
    newItem.querySelectorAll("input").forEach(input => input.value = "");
    newItem.querySelectorAll("select").forEach(select => select.selectedIndex = 0);
    sizesContainer.appendChild(newItem);
  });

  // Remove size row
  sizesContainer.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-size")) {
      const row = e.target.closest(".size-item");
      if (sizesContainer.children.length > 1) {
        row.remove();
      } else {
        alert("At least one size is required!");
      }
    }
  });
</script>
