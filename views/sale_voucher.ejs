<%- include('head.ejs') %>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>

<style>
  .kbd-hint {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-bottom-width: 2px;
    padding: 0 0.4rem;
    border-radius: 0.4rem;
    font-size: 0.75rem;
    margin-left: 0.4rem;
  }
  .swal2-customer-list {
    max-height: 320px;
    overflow-y: auto;
    text-align: left;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
  }
  .swal2-customer-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px dashed #eee;
  }
  .swal2-customer-item:last-child {
    border-bottom: 0;
  }
  .swal2-customer-item:hover {
    background: #f3f4f6;
  }
  .swal2-customer-item.active {
    background: #e8f0fe;
  }
  .swal2-search-input {
    width: 100%;
    margin-bottom: 0.5rem;
  }

  /* Qty controls */
  .qty-controls {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
  }
  .qty-controls .btn {
    padding: 0.15rem 0.45rem;
  }
  .qty-input {
    width: 68px !important;
    text-align: center;
    padding: 0.15rem 0.35rem !important;
    height: 32px;
  }
</style>

<div class="container mt-4 p-5" id="voucherPage">
  <h2>Sale Voucher</h2>

  <form id="saleForm">
    <div class="row">
      <div class="col-md-7">
        <!-- Customer Info -->
        <div class="mb-3">
          <label class="d-flex align-items-center justify-content-between">
            <span>Customer Name</span>
            <button
              type="button"
              id="pickCustomerBtn"
              class="btn btn-sm btn-outline-secondary"
              title="Open customer picker (Ctrl+K)"
            >
              <i class="bi bi-people"></i>
              Pick Customer <span class="kbd-hint">Ctrl+K</span>
            </button>
          </label>
          <input
            type="text"
            id="customerName"
            name="customerName"
            class="form-control"
            placeholder="Type customer name"
            required
          />
          <div class="form-text">
            Type freely. Use “Pick Customer” to search & select (contains
            match). Navigate picker with <b>↑/↓</b>, choose with <b>Enter</b>.
          </div>
        </div>

        <div class="mb-3">
          <label>Address</label>
          <input
            type="text"
            id="customerAddress"
            name="customerAddress"
            class="form-control"
            placeholder="Enter/select address"
          />
        </div>

        <div class="mb-3">
          <label>Phone</label>
          <input
            type="text"
            id="customerPhone"
            name="customerPhone"
            class="form-control"
            placeholder="Enter/select phone"
          />
          <div class="form-text">
            Customers are unique by <b>Name + Address + Phone</b>.
          </div>
        </div>
      </div>
    </div>

    <!-- Barcode Scan / Manual -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="d-flex align-items-center">
          <span>Scan Barcode</span>
          <span class="ms-2 text-muted small"
            >(Start <span class="kbd-hint">Ctrl+S</span> · Stop
            <span class="kbd-hint">Ctrl+X</span>)</span
          >
        </label>
        <div
          id="reader"
          style="width: 420px; height: 240px; border: 2px solid #000099"
          class="bg-info"
        ></div>
        <button
          type="button"
          id="toggleScan"
          class="btn btn-primary mt-2 mb-1"
          title="Ctrl+S to start, Ctrl+X to stop"
        >
          <i class="bi bi-upc-scan"></i>
          Start Scanner
        </button>
      </div>

      <div class="col-md-6">
        <label class="d-flex align-items-center">
          <span>Enter Barcode Manually</span>
          <span class="ms-2 text-muted small">
            (Focus <span class="kbd-hint">Ctrl+B</span> · Add
            <span class="kbd-hint">Enter</span> /
            <span class="kbd-hint">Ctrl+A</span>)
          </span>
        </label>
        <div class="input-group">
          <input
            type="text"
            id="manualBarcode"
            class="form-control"
            placeholder="Enter barcode"
          />
          <button
            type="button"
            id="addManualBtn"
            class="btn btn-primary"
            title="Add (Enter / Ctrl+A)"
          >
            <i class="bi bi-plus-square"></i> Add
          </button>
        </div>
      </div>
    </div>

    <!-- Sale Table -->
    <table class="table table-bordered align-middle" id="saleItemsTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Size</th>
          <th>Unit</th>
          <th style="width: 280px">Qty</th>
          <th>Remaining Stock</th>
          <th>Unit Price</th>
          <th>Discount</th>   <!-- NEW -->
          <th>Subtotal</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="6" class="text-end">Total:</td>
          <td id="totalAmount">0.00</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="6" class="text-end">
            <div class="d-flex justify-content-end align-items-center gap-2">
              <span>Discount:</span>
              <select
                id="discountType"
                class="form-select form-select-sm"
                style="width: auto"
              >
                <option value="amount" selected>Amount</option>
                <option value="percent">% Percent</option>
              </select>
              <input
                type="number"
                id="discountValue"
                class="form-control form-control-sm"
                style="width: 140px"
                min="0"
                step="0.01"
                value="0"
              />
              <span class="text-muted small">(Auto-capped)</span>
            </div>
          </td>
          <td id="discountAmount">0.00</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="6" class="text-end fw-bold">
            Grand Total (After Discount):
          </td>
          <td id="grandTotal" class="fw-bold">0.00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <!-- Payment -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label>Amount Paid Now</label>
        <input
          type="number"
          id="amountPaid"
          class="form-control"
          min="0"
          step="0.01"
        />
        <div
          id="paidWarning"
          class="text-danger small mt-1"
          style="display: none"
        >
          Paid amount exceeds grand total; adjusted.
        </div>
      </div>

      <div class="col-md-4">
        <label>Balance</label>
        <input type="text" id="balance" class="form-control" readonly />
      </div>
    </div>

    <div id="insufficientBox" class="alert alert-danger d-none"></div>

    <input type="hidden" name="items" id="itemsInput" />
    <input type="hidden" id="discountTypeHidden" name="discountTypeHidden" />
    <input type="hidden" id="discountValueHidden" name="discountValueHidden" />

    <button type="submit" class="btn btn-success mb-5">
      <i class="bi bi-printer"></i> Save & Print
    </button>
  </form>
</div>

<!-- Printable Voucher -->
<div
  id="printVoucher"
  style="display: none; font-family: Arial; width: 80%; margin: auto"
>
  <h3 class="text-center">Sales Invoice</h3>
  <p><b>Customer:</b> <span id="pCustomer"></span></p>
  <p>
    <b>Address:</b> <span id="pAddress"></span> | <b>Phone:</b>
    <span id="pPhone"></span>
  </p>
  <p><b>Invoice:</b> <span id="pInvoice"></span></p>
  <table border="1" width="100%" cellspacing="0" cellpadding="5">
    <thead>
      <tr>
        <th>Product</th>
        <th>Size</th>
        <th>Unit</th>
        <th>Qty</th>
        <th>Unit Price</th>
         <th>Discount</th> <!-- NEW -->
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="pItems"></tbody>
    <tfoot>
      <tr>
        <td colspan="5" align="right"><b>Total</b></td>
        <td id="pTotal"></td>
      </tr>
      <tr>
        <td colspan="5" align="right"><b>Discount</b></td>
        <td id="pDiscount"></td>
      </tr>
      <tr>
        <td colspan="5" align="right"><b>Grand Total</b></td>
        <td id="pGrand"></td>
      </tr>
      <tr>
        <td colspan="5" align="right"><b>Paid</b></td>
        <td id="pPaid"></td>
      </tr>
      <tr>
        <td colspan="5" align="right"><b>Balance</b></td>
        <td id="pBalance"></td>
      </tr>
    </tfoot>
  </table>
</div>

<!-- Scan Notification Sound -->
<audio id="scanSound" src="/sounds/scan.mp3" preload="auto"></audio>

<!-- Data payloads -->
<script id="PRODUCTS_DATA" type="application/json">
  <%- JSON.stringify(productSizes) %>
</script>
<script id="CUSTOMERS_DATA" type="application/json">
  <%- JSON.stringify(customers) %>
</script>

<script src="/js/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/sale.js"></script>

<%- include('foot.ejs') %>
